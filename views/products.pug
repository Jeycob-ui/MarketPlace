extends layout

block styles
  link(rel="stylesheet", href="/productos.css")

block content
  h1 Productos
  .actions
    a(href='/products/new') Nuevo producto
  //-Buscar y filtrar productos
  form(action='/products' method='get' class='product-search')
    input(type='text' name='q' placeholder='Buscar título o descripción' value=(query && query.q) || '')
    input(type='number' step='1' name='minPrice' placeholder='Precio min (COP)' value=(query && query.minPrice) || '')
    input(type='number' step='1' name='maxPrice' placeholder='Precio max (COP)' value=(query && query.maxPrice) || '')
    select(name='categoryId')
      option(value='') Todas las categorías
      each cat in categories
        option(value=cat.id selected=(query && query.categoryId == cat.id))= cat.name
    select(name='sort')
      option(value='') Orden por
      option(value='price_asc' selected=(query && query.sort==='price_asc')) Precio ↑
      option(value='price_desc' selected=(query && query.sort==='price_desc')) Precio ↓
      option(value='newest' selected=(query && query.sort==='newest')) Más recientes
      option(value='oldest' selected=(query && query.sort==='oldest')) Más antiguos
    button(type='submit') Buscar
  if products.length === 0
    p No hay productos
  else
    .products-grid
      each p in products
        .product-card
          if p.image
            img(src=`data:${p.imageMimeType || 'image/jpeg'};base64,${p.image}` alt=p.title class='product-image')
          .product-info
            if p.Category
              .product-category= p.Category.name
            h3.product-title= p.title
            p.product-price #{formatCOP(p.price)}
            p.product-stock 
              if p.quantity > 0
                span.in-stock En stock (#{p.quantity})
              else
                span.out-stock Sin stock
            p.product-description= p.description
            .product-actions
              a.btn.btn-info(href=`/products/${p.id}`) Ver detalles
              if p.quantity > 0
                if currentUser
                  form.add-to-cart-form(action=`/cart/add/${p.id}` method='POST')
                    button.btn.btn-success(type='submit') Añadir al carrito
                else
                  button.btn.btn-success.btn-need-login(type='button' data-productid=p.id) Añadir al carrito
              else
                button.btn.btn-disabled(disabled) Agotado
              if currentUser && (currentUser.role === 'admin' || currentUser.role === 'vendedor')
                a.btn.btn-edit(href=`/products/${p.id}/edit`) Editar
                form.delete-form(action=`/products/${p.id}?_method=DELETE` method='post')
                  button.btn.btn-danger(type='submit' onclick="return confirm('¿Eliminar este producto?')") Eliminar

  
