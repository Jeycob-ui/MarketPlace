extends layout

block styles 
    link(rel="stylesheet", href="/index.css")

block content
  form(action='/' method='get' class='product-search')
    input(type='text' name='q' placeholder='Buscar título o descripción' value=(query && query.q) || '')
    input(type='number' step='1' name='minPrice' placeholder='Precio min (COP)' value=(query && query.minPrice) || '')
    input(type='number' step='1' name='maxPrice' placeholder='Precio max (COP)' value=(query && query.maxPrice) || '')
    label
    select(name='sort')
      option(value='') Orden por
      option(value='price_asc' selected=(query && query.sort==='price_asc')) Precio ↑
      option(value='price_desc' selected=(query && query.sort==='price_desc')) Precio ↓
      option(value='newest' selected=(query && query.sort==='newest')) Más recientes
      option(value='oldest' selected=(query && query.sort==='oldest')) Más antiguos
    button(type='submit') Buscar 
  h1 Productos recientes
  if products.length === 0
    p No hay productos aún.
  .grid
    each p in products
      .card
        if p.image
          img(src=`data:${p.imageMimeType || 'image/jpeg'};base64,${p.image}` style='width: 100%; max-height: 200px; object-fit: cover; margin-bottom: 10px;')
        h3= p.title
        p(style='color: #666; font-size: 0.9em; margin: 5px 0;')= p.description ? (p.description.substring(0, 100) + (p.description.length > 100 ? '...' : '')) : 'Sin descripción'
        p
          strong Precio: 
          | #{formatCOP(p.price)}
        p(style='color: ' + (p.quantity > 0 ? '#28a745' : '#dc3545'))
          strong Stock: 
          | #{p.quantity} #{p.quantity > 0 ? 'disponibles' : 'sin stock'}
        a(href=`/products/${p.id}` style='display: block; margin: 10px 0; padding: 8px; background-color: #007bff; color: white; text-align: center; text-decoration: none; border-radius: 4px;') Ver detalles
        if p.quantity > 0
          if currentUser
            form(action=`/cart/add/${p.id}` method='post' style='margin: 10px 0;')
              button(type='submit' class='card-add-btn' style='width: 100%;' ) Añadir al carrito
          else
            button(type='button' class='card-add-btn btn-need-login' style='width: 100%;' ) Añadir al carrito
        else
          button(type='button' disabled class='card-add-btn btn-disabled' style='width: 100%;') Agotado
